---
title: ""
author: "Mason Shihab"
date: "3/13/2021"
output:
  pdf_document:
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(lubridate)
library(tidyverse)
library(ggplot2)
library(readr)
library(tidycensus)
library(rpart)
library(rpart.plot)
library(ipred)
library(readxl)
library(usdata)
library(tm)
library(stringr)
```


# Introduction

Today we will be expanding on the election data set and partition it between a test and a train data set. We will use the train data set in order to attempt to predict the remainder of the values. Various methods for doing so will be ran and compared against each other for educational and practice purposes.



## Reloading the data.
```{r}
var <- load_variables(2019, "acs1", cache = TRUE)
```


## Selecting the variables

```{r}
census_data <- get_acs(geography = "county", variables = c(med_age = "B01002_001", 
                                                           permale = "B01001_002",
                                                           bachplus = "B16010_041",
                                                           totalpop = "B01003_001",
                                                           unemployed = "B27011_008",
                                                           employed =	"B27011_003",
                                                           foodstamp = "B09010_002",
                                                           ilefnhi= "B27011_007",
                                                           ilufnhi= "B27011_012",
                                                           nilfnhi = "B27011_017",
                                                           gini = "B19083_001",
                                                           med_income = "B19013_001",
                                                           med_2bed = "B25031_004",
                                                           single_mom = "B11012_010",
                                                           lessthan_hs = "B16010_002",
                                                           housing_units = "B25001_001"), 
                       year = 2019)





census_step = census_data %>% 
  pivot_wider(id_cols = c(NAME), names_from = variable, values_from = estimate) %>% 
  separate(NAME, into = c("county", "state"), sep = ", ") %>% arrange(state, county)


census_wider = census_step %>% 
  mutate(permale = permale/totalpop, 
         bachplus = bachplus/totalpop, unemployed_rate = unemployed/(employed+unemployed), employed_rate = employed/(employed+unemployed),
         foodstamp = foodstamp/totalpop, no_health_ins = 
           (ilefnhi+ilufnhi+nilfnhi)/totalpop, single_mom = 
           single_mom/totalpop, lessthan_hs = lessthan_hs/totalpop) %>% 
  select(-ilefnhi,-ilufnhi,-nilfnhi, -unemployed, -employed)
ACS_vars = drop_na(census_wider)



```



## Combine with Election Dataset

```{r}
election = read_csv("../data/raw/president_county_candidate.csv", 
    col_types = cols(won = col_skip()))



election2 = election %>% arrange(state, county) %>% 
  group_by(state, county) %>% 
  mutate(pctvote = 100*total_votes/sum(total_votes)) %>% 
  filter(candidate %in% c("Joe Biden", "Donald Trump"))

election_clean = election2 %>% 
  pivot_wider(id_cols = c(state, county), 
              names_from = candidate, values_from = pctvote)

ACS_election = election_clean %>% inner_join(ACS_vars, by = c("state", "county")) %>% select(-`Joe Biden`) %>% rename(pertrump = 'Donald Trump') %>% mutate(pertrump = pertrump/100)

```

```{r}
keyfile = read_csv("../data/raw/ZIP-COUNTY-FIPS_2010-03.csv") %>% 
  mutate(state_full = abbr2state(STATE),) %>% rename(county = COUNTYNAME, state = state_full, fips = STCOUNTYFP) %>% select(-ZIP) %>% distinct() 
```

```{r}
ACS_election_key = ACS_election %>% inner_join(keyfile, by = c("state", "county")) 
```


## Land and Density

```{r}
land = read_xlsx("../data/raw/land.xlsx") %>% rename(fips = STCOU, area = LND010190D) %>% mutate(fips = as.numeric(fips)) 
```


```{r}
ACS_election_land = ACS_election_key %>% inner_join(land, by = "fips")
```

```{r}
ACS_election_land = ACS_election_land %>% mutate(pop_density = totalpop/area, housing_density = housing_units/area)
```


## % in Poverty

```{r}
poverty = read_xlsx("../data/raw/poverty.xlsx", skip = 1) %>% mutate(pct_all_in_pov = as.numeric(`Poverty Percent, All Ages`)/100, .keep = "unused")
poverty$fips = as.numeric(paste(poverty$`State FIPS Code`, poverty$`County FIPS Code`, sep = ""))
```

```{r}
merge1 = ACS_election_land %>% inner_join(poverty, by = "fips") %>% 
  select(-STATE, -CLASSFP, -Areaname, -`State FIPS Code`, -`County FIPS Code`) 
```


## Police Performance Vars


```{r}
file = "../data/raw/scorecard.csv"
scorecard_raw = read_csv(file)
scorecard_raw = scorecard_raw %>% select("fips_state_code", "fips_county_code",
                                         "calc_police_violence_score","calc_police_accountability_score",
                                         "calc_approach_to_policing_score","calc_police_funding_score")
scorecard_raw = data.frame(sapply(scorecard_raw, function(x) as.numeric(gsub("%", "", x)))) %>%
  rename(police_violence_score = calc_police_violence_score, 
         police_accountability_score=calc_police_accountability_score, 
         approach_to_policing_score = calc_approach_to_policing_score, 
         police_funding_score = calc_police_funding_score) %>% 
  mutate(fips_state_code=as.character(fips_state_code), fips_county_code = as.character(fips_county_code))
```

```{r}

scorecard_raw$fips_county_code = str_pad(scorecard_raw$fips_county_code, 3, pad = "0")

scorecard_raw$fips = str_c(scorecard_raw$fips_state_code, scorecard_raw$fips_county_code)

scorecard_clean = scorecard_raw %>% select(-fips_state_code,-fips_county_code) %>% 
  mutate(fips = as.numeric(fips)) %>% group_by(fips) %>% 
  summarise(police_violence_score = mean(police_violence_score), 
            police_accountability_score = mean(police_accountability_score), 
            approach_to_policing_score = mean(approach_to_policing_score), 
            police_funding_score = mean(police_funding_score))


```

```{r}
merge2 = merge1 %>% inner_join(scorecard_clean, by = "fips")

```

## HHA


```{r}
hha_raw = read_excel('../data/raw/HHS_OCDO_TDWG_COVID-19_Community_Vulnerability_Crosswalk.xlsx') %>% as_tibble()
```

```{r}
mean_data = hha_raw %>% select(`County FIPS`,`HHA Score`) %>%
  rename(fips = `County FIPS`, hha_score = `HHA Score`) %>%
  mutate(fips=as.numeric(fips))%>%
  group_by(fips) %>%
  summarise(mean_hha_score = mean(hha_score))%>%
  as_tibble()
```

```{r}
merge3 = merge2 %>% inner_join(mean_data, by = "fips")

```

## Soc Vulnerability


```{r}
file = "../data/raw/Social_Vulnerability_Index_2018.csv"
vulner_raw = read_csv(file)
vulner_raw = vulner_raw %>% select("FIPS","RPL_THEMES")%>% filter(RPL_THEMES>=0)%>%
  rename(fips = FIPS, svi_overall=RPL_THEMES)
```

```{r}
vulner_raw$fips = as.numeric(vulner_raw$fips)
```

```{r}
merge4 = merge3 %>% inner_join(vulner_raw, by = "fips")

```

## County Health Rank


```{r}
file = "../data/raw/analytic_data2020_0.csv"
healthrank_raw = read_csv(file, skip=1)
healthrank_raw= healthrank_raw %>% select(fipscode,v141_rawvalue, v142_rawvalue, 
                          v024_rawvalue, v154_rawvalue, v136_rawvalue, v002_rawvalue) %>%
  rename(res_seg_black_white = v141_rawvalue, res_seg_nonwhite_white = v142_rawvalue, pct_child_in_pov = v024_rawvalue, sev_hou_cost_burden = v154_rawvalue, sev_hou_prob = v136_rawvalue, poor_fair_health = v002_rawvalue , fips =fipscode)
```

```{r}
healthrank_raw$fips = as.numeric(healthrank_raw$fips)
```

```{r}
merge5 = merge4 %>% inner_join(healthrank_raw, by = "fips")
```


```{r}

stopwords2 = c(" County")

merge5$county = removeWords(merge5$county, stopwords2)
```



## state expenses

```{r}
state_expenses = read_xlsx("../data/raw/expenditures.xlsx") %>% rename(state = State, spend_per_capita = `State and Local Direct General Expenditures, Per Capita`)
```

```{r}
merge6 = merge5 %>% inner_join(state_expenses, by = "state")
```


## state unemployment benefits

```{r}
unemp_bens = read_xlsx("../data/raw/unemployment bens.xlsx")

stopwords3 = c("Individual", "w/dependents", "up", "to")

unemp_bens$amount = removeWords(unemp_bens$amount, stopwords3)

unemp_bens = unemp_bens %>% separate(amount, into = c("individual", "w_dependents"), sep = "  ") %>% mutate(individual = extract_numeric(individual), w_dependents = extract_numeric(w_dependents))

unemp_bens$w_dependents = ifelse(is.na(unemp_bens$w_dependents), unemp_bens$individual, unemp_bens$w_dependents) 

unemp_bens = unemp_bens %>% mutate(average_bens = (as.numeric(individual)+as.numeric(w_dependents))/2) %>% mutate(benefits_possible = average_bens*weeks) 
```

```{r}
merge7 = merge6 %>% inner_join(unemp_bens, by = "state")
```



## add response


```{r}
hope = read.csv("https://raw.githubusercontent.com/grammakov/USA-cities-and-states/master/us_cities_states_counties.csv", sep = "|") %>% rename(State = State.full) 
hope = hope %>% select(-City.alias)
countycrime = read_xlsx("../data/raw/countycrime.xlsx") %>% select(State, County, Total_Theft)
citycrime = read_xlsx("../data/raw/citycrime.xlsx") 
```


```{r}
citycrime$State = removeNumbers(citycrime$State)
citycrime$City = removeNumbers(citycrime$City)

countycrime$State = removeNumbers(countycrime$State)
countycrime$County = removeNumbers(countycrime$County)
```


```{r}
countycrime$county_words = sapply(gregexpr("\\S+", countycrime$County), length)


stopwords = c(" County Police Department", " County Unified Police Department", " Public Safety")

countycrime$County = removeWords(countycrime$County, stopwords)

countycrime = countycrime %>% group_by(County, State) %>% summarise(Total_Theft = sum(Total_Theft)) %>% ungroup()

```



```{r}

citycrimecounty = hope %>% inner_join(citycrime, by = c("State", "City")) %>% distinct() 

citycrimecounty$County = tolower(citycrimecounty$County)
citycrimecounty$County = str_to_title(citycrimecounty$County)

```


```{r}
citiestocounties = citycrimecounty %>% group_by(County, State) %>% summarise(Total_Thefts = sum(Total_Thefts))
citiestocounties$County_State = paste(citiestocounties$County, citiestocounties$State)
countycrime$County_State = paste(countycrime$County, countycrime$State)

```

```{r}
missingcounties = citiestocounties %>% filter(!(County_State %in% countycrime$County_State))  %>% rename(Total_Theft = Total_Thefts)
```

```{r}
response = rbind(missingcounties, countycrime) %>% drop_na() %>% rename(county = County, state = State) 
```

```{}
merge_with_response = merge? %>% inner_join(response, by = c("state", "county")) 
```


